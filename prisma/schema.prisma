generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== MODELOS ====================

// Usuario
model User {
  id       String   @id @default(uuid())
  clerkId  String   @unique
  email    String   @unique
  name     String?
  lastName String?
  imageUrl String?
  role     UserRole @default(USER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  organizedRouteCalls RouteCall[] // Rutas que organiza
  reviews             Review[]
  favorites           Favorite[]
  attendances         Attendance[]
  uploadedPhotos      Photo[]

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
}

// Ruta predefinida (las 17 rutas)
model Route {
  id                  String       @id @default(uuid())
  name                String
  slug                String       @unique
  image               String
  approximateDistance String
  description         String       @db.Text
  gpxFileUrl          String?
  mapEmbedUrl         String?
  level               RouteLevel[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  routeCalls RouteCall[] // Convocatorias que usan esta ruta
  reviews    Review[]
  favorites  Favorite[]
  photos     Photo[]

  @@map("routes")
}

enum RouteLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

// Convocatoria de ruta (REFACTORIZADO)
model RouteCall {
  id String @id @default(uuid())

  // Ruta: Puede ser predefinida O nueva (custom)
  routeId         String? // ‚Üê Opcional: Si es NULL = ruta nueva
  customRouteName String? // ‚Üê Solo si routeId es NULL

  // Organizador
  organizerId String

  // Detalles de la convocatoria
  title       String? // ‚Üê Opcional (por si quieren un t√≠tulo custom)
  description String? @db.Text // Comentarios importantes
  image       String? // ‚Üê Imagen de la convocatoria

  // Fecha y hora
  dateRoute DateTime // Fecha y hora de inicio

  // Ritmo (tus ritmos personalizados)
  pace RoutePace

  // Estado
  status RouteCallStatus @default(SCHEDULED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  route         Route?         @relation(fields: [routeId], references: [id], onDelete: SetNull)
  organizer     User           @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  attendances   Attendance[]
  meetingPoints MeetingPoint[] // ‚Üê M√∫ltiples puntos de encuentro

  @@map("route_calls")
}

// Ritmo personalizado de Los Inmaduros
enum RoutePace {
  ROCA // ü™® Nivel Roca
  CARACOL // üêå Nivel Caracol
  GUSANO // üêõ Nivel Gusano
  MARIPOSA // ü¶ã Nivel Mariposa
  EXPERIMENTADO // üöÄ Nivel Experimentado
  LOCURA_TOTAL // ‚ò†Ô∏è Nivel Locura total
  MIAUCORNIA // üêàü¶Ñ Nivel Miaucornia
}

enum RouteCallStatus {
  SCHEDULED // Programada
  ONGOING // En curso
  COMPLETED // Completada
  CANCELLED // Cancelada
}

// Puntos de encuentro (NUEVO MODELO)
model MeetingPoint {
  id          String @id @default(uuid())
  routeCallId String

  // Tipo de punto
  type MeetingPointType @default(PRIMARY) // Principal o secundario

  // Ubicaci√≥n
  name       String // "Puerta de Alcal√°", "Explanada", "Otro"
  customName String? // Solo si name = "Otro"
  location   String? // URL de Google Maps

  // Hora (solo para puntos secundarios)
  time DateTime? // Hora del punto secundario

  createdAt DateTime @default(now())

  // Relaci√≥n
  routeCall RouteCall @relation(fields: [routeCallId], references: [id], onDelete: Cascade)

  @@map("meeting_points")
}

enum MeetingPointType {
  PRIMARY // Punto principal
  SECONDARY // Punto secundario
}

// Asistencia a una convocatoria
model Attendance {
  id          String @id @default(uuid())
  routeCallId String
  userId      String

  status AttendanceStatus @default(CONFIRMED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  routeCall RouteCall @relation(fields: [routeCallId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([routeCallId, userId])
  @@map("attendances")
}

enum AttendanceStatus {
  CONFIRMED
  CANCELLED
}

// Review de una ruta
model Review {
  id      String @id @default(uuid())
  routeId String
  userId  String

  rating  Int
  comment String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, routeId])
  @@map("reviews")
}

// Favoritos
model Favorite {
  id      String @id @default(uuid())
  routeId String
  userId  String

  createdAt DateTime @default(now())

  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([routeId, userId])
  @@map("favorites")
}

// Galer√≠a de fotos
model Photo {
  id      String  @id @default(uuid())
  routeId String?
  userId  String

  imageUrl   String
  caption    String? @db.Text
  isApproved Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  route Route? @relation(fields: [routeId], references: [id], onDelete: SetNull)
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("photos")
}
