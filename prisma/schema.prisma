generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== MODELS ====================

// User
model User {
  id       String   @id @default(uuid())
  clerkId  String   @unique
  email    String   @unique
  name     String?
  lastName String?
  imageUrl String?
  role     UserRole @default(USER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizedRouteCalls RouteCall[] // Tours organized by the user
  reviews             Review[]
  favorites           Favorite[]
  attendances         Attendance[]
  uploadedPhotos      Photo[]

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
}

// Predefined route (all 17 routes)
model Route {
  id                  String       @id @default(uuid())
  name                String
  slug                String       @unique
  image               String
  approximateDistance String
  description         String       @db.Text
  gpxFileUrl          String?
  mapEmbedUrl         String?
  level               RouteLevel[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  routeCalls RouteCall[] // Calls that use this route
  reviews    Review[]
  favorites  Favorite[]
  photos     Photo[]

  @@map("routes")
}

enum RouteLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

// Call for route proposals
model RouteCall {
  id String @id @default(uuid())

  // Route: Can be predefined OR new (custom)
  routeId         String? // ‚Üê Optional: If NULL = new path
  customRouteName String? // ‚Üê Only if routeId is NULL

  // Organizer
  organizerId String

  // Details of the call for applications
  title       String? // ‚Üê Optional (if they want a custom title)
  description String? @db.Text // Important comments
  image       String? // ‚Üê Call image

  // Date and time
  dateRoute DateTime // Start date and time

  // Pace (your custom paces)
  pace RoutePace

  // Status
  status RouteCallStatus @default(SCHEDULED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  route         Route?         @relation(fields: [routeId], references: [id], onDelete: SetNull)
  organizer     User           @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  attendances   Attendance[]
  meetingPoints MeetingPoint[] // ‚Üê Multiple meeting points

  @@map("route_calls")
}

// Los Inmaduros custom pace
enum RoutePace {
  ROCA // ü™® Rock Level
  CARACOL // üêå Snail Level
  GUSANO // üêõ Worm Level
  MARIPOSA // ü¶ã Butterfly Level
  EXPERIMENTADO // üöÄ Experienced Level
  LOCURA_TOTAL // ‚ò†Ô∏è Total Madness Level
  MIAUCORNIA // üêàü¶Ñ Miaucornia Level
}

enum RouteCallStatus {
  SCHEDULED // Scheduled
  ONGOING // Ongoing
  COMPLETED // Completed
  CANCELLED // Cancelled
}

// Meeting points (NEW MODEL)
model MeetingPoint {
  id          String @id @default(uuid())
  routeCallId String

  // Point type
  type MeetingPointType @default(PRIMARY) // Primary or secondary

  // Location
  name       String // "Puerta de Alcal√°", "Explanada", "Other"
  customName String? // Only if name = "Other"
  location   String? // Google Maps URL

  // Time (only for secondary points)
  time DateTime? // Secondary point time

  createdAt DateTime @default(now())

  // Relation
  routeCall RouteCall @relation(fields: [routeCallId], references: [id], onDelete: Cascade)

  @@map("meeting_points")
}

enum MeetingPointType {
  PRIMARY // Primary point
  SECONDARY // Secondary point
}

// Attendance to a call
model Attendance {
  id          String @id @default(uuid())
  routeCallId String
  userId      String

  status AttendanceStatus @default(CONFIRMED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  routeCall RouteCall @relation(fields: [routeCallId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([routeCallId, userId])
  @@map("attendances")
}

enum AttendanceStatus {
  CONFIRMED
  CANCELLED
}

// Route review
model Review {
  id      String @id @default(uuid())
  routeId String
  userId  String

  rating  Int
  comment String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, routeId])
  @@map("reviews")
}

// Favorites
model Favorite {
  id      String @id @default(uuid())
  routeId String
  userId  String

  createdAt DateTime @default(now())

  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([routeId, userId])
  @@map("favorites")
}

// Photo gallery
model Photo {
  id      String  @id @default(uuid())
  routeId String?
  userId  String

  imageUrl   String
  caption    String? @db.Text
  isApproved Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  route Route? @relation(fields: [routeId], references: [id], onDelete: SetNull)
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("photos")
}